{% extends 'base.html' %}

{% block content %}
<div class="w-full max-w-7xl mx-auto py-12 px-4">

  <!-- Jumbo card -->
  <div class="w-full bg-gray-900 text-gray-100 rounded-xl border border-gray-700 p-6 mb-6 shadow-lg">

    <h1 class="text-xl font-bold text-emerald-400 mb-3">
      Win more when the score lands in the middle zone
    </h1>

    <p class="text-gray-300 mb-4 leading-relaxed">
      Middles exploit overlapping bookmaker lines. If the result falls within the target range,
      both bets win. Outside the range, your downside stays limited.
    </p>

    <div class="border-t border-gray-700 pt-4 mt-4 flex flex-col md:flex-row justify-between gap-6">

      <!-- Left Section -->
      <div class="flex-1">
        <p class="mb-1">
          Total middles found:
          <strong class="text-white">{{ total_middle_items }}</strong>
        </p>

        <p class="mb-1">
          Positive EV middles:
          <strong class="text-white">{{ total_items_with_positive_ev }}</strong>
        </p>

        <p class="text-gray-400">
          Upgrade to view full positive EV analysis and lossless middles.
        </p>

        <a href="/#pricing"
          class="inline-block mt-4 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2.5 px-5 rounded-lg shadow-md transition">
          View Plans
        </a>
      </div>

      <!-- Right Section -->
      <div class="flex items-center justify-center md:justify-end">
        <div class="trustpilot-widget"></div>
      </div>

    </div>

  </div>



  <!-- Warning -->
  <div role="alert" class="mb-9 bg-red-900/40 border border-red-700 p-4 rounded-xl text-red-300 shadow">
    <p class="text-sm leading-relaxed">
      Always verify odds before placing your bets. Small data delays can cause mismatches.
    </p>
  </div>


  <!-- Header + pagination -->
  <div class="flex flex-col md:flex-row justify-between items-center mb-4">
    <div>
      <p class="text-xl font-bold text-white">Found {{ total_middle_items }} middles</p>
      <p class="text-gray-200 text-sm">Examples with lower confidence ↓</p>
    </div>

    <div class="flex gap-2 mt-3 md:mt-0">
      <button id="prev-page"
        class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded text-gray-700 disabled:opacity-50">
        ← Prev
      </button>
      <button id="next-page"
        class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded text-gray-700 disabled:opacity-50">
        Next →
      </button>
    </div>
  </div>


  <!-- Table -->
  <div class="overflow-x-auto border border-gray-200 rounded-lg shadow-sm">
    <table id="middles-body" class="w-full text-sm text-gray-800">
      <thead class="bg-gray-100 text-gray-800">
        <tr>
          <th class="px-4 py-3 font-semibold">Actions</th>
          <th class="px-4 py-3 font-semibold">Bookmaker</th>
          <th class="px-4 py-3 font-semibold">Time</th>
          <th class="px-4 py-3 font-semibold">Event</th>
          <th class="px-4 py-3 font-semibold">Market</th>
          <th class="px-4 py-3 font-semibold">
            <div class="tooltip" data-tip="Confidence score based on market averages">Confidence</div>
          </th>
          <th class="px-4 py-3 font-semibold text-right">Odds</th>
          <th></th>
        </tr>
      </thead>
      <!-- Body here -->
    </table>
  </div>

</div>

{% block sidebar %}
  {% include 'partials/sidebar.html' %}
{% endblock sidebar %}

<script>
  const API_URL = "/api/middles";

  let currentPage = 1;
  const perPage = 60;
  let _market = '';
  let _sort = 'profit';
  let _time = ''

  function fetchMiddles(page = 1, sort = 'profit', market = _market, commence_time = _time) {
    _market = market;
    _sort = sort
    _time = commence_time
    $.ajax({
      url: API_URL,
      data: { page: page, limit: perPage, sort: _sort, market: _market, commence_time: _time },
      method: "GET",
      success: function (response) {
        if (response.data.length == 0) {
          $("#middles-body").html(`
              <tr>
                <td colspan="7" class="text-center py-4 text-gray-500">
                  Failed to load data/No results found.
                </td>
              </tr>
            `);
        } else {
          renderMiddles(response.data);
          updatePagination(response.page, response.total_pages);
        }
      },
      error: function () {
        $("#middles-body").html(`
              <tr>
                <td colspan="7" class="text-center py-4 text-gray-500">
                  Failed to load data.
                </td>
              </tr>
            `);
      },
    });
  }

  function renderMiddles(items) {
    const tbodyContainer = $("#middles-body");
    //tbodyContainer.empty();
    removeElementsByClass('middle_record')

    // Group by surebet_id
    const grouped = {};
    items.forEach((item) => {
      if (!grouped[item.middle_id]) grouped[item.middle_id] = [];
      grouped[item.middle_id].push(item);
    });

    Object.keys(grouped).forEach((id) => {
      const group = grouped[id];
      const tbody = $("<tbody>")
        .addClass("middle_record border-t border-gray-200")
        .attr("data-id", id);

      group.forEach((item, idx) => {
        tbody.append(`
          <tr class="hover:bg-gray-700 transition border-b border-gray-700">
            
            <!-- ACTIONS + CALCULATOR -->
            ${
              idx == 0
                ? `<td rowspan="${group.length}" class="px-4 py-3 align-top text-gray-300">
                    <div class="flex flex-col items-start gap-2">
                      
                      <label for="calculator_modal"
                        data-page="middles" data-item="${item.middle_id}"
                        class="calc-btn p-2 rounded-lg bg-gray-800 border border-gray-700 text-emerald-400 hover:bg-gray-700 transition"
                        title="Middle Calculator">
                        <ion-icon class="w-5 h-5" name="calculator"></ion-icon>
                      </label>

                      <button disabled
                        class="p-2 rounded-lg bg-gray-800 border border-gray-700 text-gray-500 cursor-not-allowed"
                        title="More options">
                        <ion-icon class="w-5 h-5" name="ellipsis-vertical"></ion-icon>
                      </button>

                    </div>
                  </td>`
                : ""
            }

            <!-- BOOKMAKER -->
            <td class="px-4 py-3">
              <a href="${item.bookmaker_link}" target="_blank"
                class="text-emerald-400 font-semibold hover:underline">
                ${item.bookmaker}
              </a>
              <div class="text-xs text-gray-500">${item.sport_name || "N/A"}</div>
            </td>

            <!-- DATE -->
            ${
              idx == 0
                ? `<td rowspan="${group.length}" class="px-4 py-3 align-top">
                    <div class="text-gray-300">${item.date}</div>
                    <div class="text-xs text-gray-500">${item.time}</div>
                  </td>`
                : ""
            }

            <!-- EVENT -->
            <td class="px-4 py-3">
              <div class="text-gray-200 font-semibold">${item.event}</div>
              <div class="text-xs text-gray-500">${item.event_name || ""}</div>
              <div class="text-xs text-gray-500">${item.tournament || ""}</div>
            </td>

            <!-- MARKET -->
            <td class="px-4 py-3 text-gray-300">${item.market_type}</td>

            <!-- CONFIDENCE -->
            <td class="px-4 py-3 text-emerald-400 font-medium">${item.confidence}%</td>

            <!-- ODDS -->
            <td class="px-4 py-3 text-right">
              <a href="#" class="text-emerald-300 font-semibold hover:underline">
                ${item.odds}
              </a>
            </td>

            <!-- EXPAND ARROW -->
            ${
              idx == 0
                ? `<td rowspan="${group.length}" class="px-4 py-3 text-center align-middle">
                    <button class="p-2 rounded-lg bg-gray-800 border border-gray-700 hover:bg-gray-700 text-gray-300" title="Open all odds">
                      <ion-icon class="text-xl" name="chevron-forward"></ion-icon>
                    </button>
                  </td>`
                : ""
            }

          </tr>
        `);

      });

      // "View more middles" row
      tbody.append(`
      <tr class="bg-gray-800">
        <td colspan="8"
            class="px-4 py-3 text-emerald-400 text-sm hover:text-emerald-300 cursor-pointer border-t border-gray-700">
          <div class="w-full flex justify-end pr-2">
            + 0 more middles for this event
          </div>
        </td>
      </tr>
    `);

      tbodyContainer.append(tbody);
    })

    // attach event for calculator popout
    $(".calc-btn").on("click", function () {
      const page = $(this).data("page");
      const arb_item = $(this).data("item");

      const contentDiv = document.getElementById('calculator-arb-item')
      contentDiv.setAttribute('data-page', page)
      contentDiv.setAttribute('data-item', arb_item)

      const url = `/middle/calculator?page=${encodeURIComponent(page)}&middle_item=${encodeURIComponent(arb_item)}`
      fetch(url)
        .then(response => {
          if (!response.ok) throw new Error("Item not found or expired");
          return response.text();
        })
        .then(html => {
          contentDiv.innerHTML = html;
        })
        .catch(err => {
          console.warn(err.message);
          alert("This opportunity is no longer available. Refreshing list...");
          window.location.reload();
        });
    });
  }

  function removeElementsByClass(className) {
    let elements = document.getElementsByClassName(className);
    while (elements.length > 0) {
      elements[0].parentNode.removeChild(elements[0]);
    }
  }

  function updatePagination(page, totalPages) {
    $("#page-info").text(`Page ${page} of ${totalPages}`);
    $("#prev-page").prop("disabled", page <= 1);
    $("#next-page").prop("disabled", page >= totalPages);
    currentPage = page;
  }

  $("#prev-page").on("click", function () {
    if (currentPage > 1) fetchMiddles(currentPage - 1, _market);
  });

  $("#next-page").on("click", function () {
    fetchMiddles(currentPage + 1, _market);
  });

  // initial load
  fetchMiddles(currentPage);
</script>
{% endblock content %}