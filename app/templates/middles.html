{% extends 'base.html' %}

{% block content %}
<div class="card bg-base-100">
  <div class="card-body p-0">
    <div id="jumbotron" class="m-4 bg-blue-50 border border-blue-200 rounded-xl p-6 shadow-sm">
      <!-- Heading -->
      <h1 class="text-xl font-semibold text-blue-800 mb-3">
        Win more if the outcome lands within a range
      </h1>

      <!-- Description -->
      <p class="text-gray-700 mb-4 leading-relaxed">
        A bookmaker's middle allows you to bet on overlapping lines from different
        bookmakers and win both bets if the result falls within a specific range.
      </p>

      <hr class="border-gray-300 mb-5" />

      <!-- Main content container -->
      <div id="jumbotron-counters-actions-rating-container" class="flex flex-col md:flex-row justify-between gap-6">
        <!-- Left: Counters + Action -->
        <div class="flex-1">
          <p class="mb-1">
            We found
            <strong class="text-gray-900">{{total_middle_items}}</strong> middles for your filter
            settings.
          </p>

          <p class="mb-1">
            Of these,
            <strong class="text-gray-900">{{total_items_with_positive_ev}}</strong> middles offer a positive
            expected value.
          </p>

          <p>
            To see middles with a positive expected value and lossless
            surebets-middles, please choose a plan.
          </p>

          <div class="mt-4">
            <a href="{{url_for('plans.overview')}}"
              class="inline-block bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-5 rounded-lg shadow transition">
              Plans and Registration
            </a>
          </div>
        </div>

        <!-- Right: Rating section -->
        <div id="jumbotron-rating-container" class="flex flex-col items-center justify-center md:items-end">
          <!-- Trustpilot Widget Embed -->
          <div class="trustpilot-widget">
          </div>
        </div>
      </div>
    </div>

    <!-- warning here -->
    <div class="p-4">
      <div role="alert" class="alert alert-error alert-soft">
        <p class="text-red-600">Before you place any bets, we strongly recommend that you check the events, odds, and
          bookmaker's rules. <br><br>We are constantly working to improve the quality of our service, but errors and
          discrepancies can occur, unfortunately.</p>
      </div>
    </div>

    <!-- content here -->
    <div class="mx-4 mt-4 flex items-center justify-between">
      <div class="">
        <p class="text-2xl font-bold">Found {{total_middle_items}} middles</p>
        <p>Examples with low expected value ↓</p>
      </div>

      <div class="actions">
        <button id="prev-page" class="btn hover:bg-gray-300 px-2 py-1 rounded disabled:opacity-70">
          ← Prev
        </button>
        <button id="next-page" class="btn hover:bg-gray-300 px-4 py-2 rounded disabled:opacity-50">
          Next →
        </button>
      </div>
    </div>
    <div class="m-3 overflow-x-auto">
      <table id="middles-body" style="font-size: 12px;" class="w-full text-sm text-left text-gray-700 border-collapse">
        <thead class="bg-gray-100 text-gray-800">
          <tr>
            <th class="px-4 py-3 font-semibold">Actions</th>
            <th class="px-4 py-3 font-semibold">Bookmaker</th>
            <th class="px-4 py-3 font-semibold">Time</th>
            <th class="px-4 py-3 font-semibold">Event</th>
            <th class="px-4 py-3 font-semibold">Market</th>
            <th class="px-4 py-3 font-semibold">Confidence</th>
            <th class="px-4 py-3 font-semibold text-right">Odds</th>
            <th></th>
          </tr>
        </thead>

        <!-- body here -->
      </table>
    </div>
    <!-- datatable end -->
  </div>
</div>

<script>
  const API_URL = "/api/middles";

  let currentPage = 1;
  const perPage = 60;

  function fetchMiddles(page = 1, sort = 'profit', market = 'spreads') {
    $.ajax({
      url: API_URL,
      data: { page: page, limit: perPage, sort: sort, market: market },
      method: "GET",
      success: function (response) {
        if (response.data.length == 0) {
          $("#middles-body").html(`
              <tr>
                <td colspan="7" class="text-center py-4 text-gray-500">
                  Failed to load data.
                </td>
              </tr>
            `);
        } else {
          renderMiddles(response.data);
          updatePagination(response.page, response.total_pages);
        }
      },
      error: function () {
        $("#middles-body").html(`
              <tr>
                <td colspan="7" class="text-center py-4 text-gray-500">
                  Failed to load data.
                </td>
              </tr>
            `);
      },
    });
  }

  function renderMiddles(items) {
    const tbodyContainer = $("#middles-body");
    //tbodyContainer.empty();
    removeElementsByClass('middle_record')

    // Group by surebet_id
    const grouped = {};
    items.forEach((item) => {
      if (!grouped[item.middle_id]) grouped[item.middle_id] = [];
      grouped[item.middle_id].push(item);
    });

    Object.keys(grouped).forEach((id) => {
      const group = grouped[id];
      const tbody = $("<tbody>")
        .addClass("middle_record border-t border-gray-200")
        .attr("data-id", id);

      group.forEach((item, idx) => {
        tbody.append(`
          <tr class="hover:bg-gray-50 transition">
            <!-- Profit & Actions -->
            ${idx == 0 ? `<td rowspan="${group.length}" class="px-4 py-2 align-top">
              <div class="flex flex-col items-start">
                <!-- Action buttons -->
                <div class="flex items-center gap-2 mt-2">
                  <label for="calculator_modal" data-page="middles" data-item="${item.middle_id}" 
                    class="calc-btn p-1.5 text-gray-600 hover:text-blue-600" title="Middle calculator">
                    <ion-icon class="w-5 h-5" name="calculator"></ion-icon>
                  </label>
                  <button disabled class="p-1.5 text-gray-600 hover:text-gray-900" title="More options">
                    <ion-icon class="w-5 h-5" name="ellipsis-vertical"></ion-icon>
                  </button>
                </div>
              </div>
            </td>` : ''}

            <!-- Row: bookmaker -->
            <td class="px-4 py-2">
              <a href="${item.bookmaker_link}" target="_blank" class="text-blue-600 hover:underline">${item.bookmaker}</a>
              <div class="text-xs text-gray-500">${item.sport_name || 'N?A'}</div>
            </td>

            ${idx == 0 ? `<td rowspan="${group.length}" class="px-4 py-2 align-top">
              <a href="#" class="text-blue-600 hover:underline">${item.date}</a>
              <div class="text-xs text-gray-500">${item.time}</div>
            </td>` : ''}

            <td class="px-4 py-2">
              <a href="#" class="text-blue-600 hover:underline">${item.event}</a>
              <div class="text-xs text-gray-500">${item.event_name || ''}</div>
              <div class="text-xs text-gray-500">${item.tournament || ''}</div>
            </td>

            <td class="px-4 py-2 text-gray-600">${item.market_type}</td>
            <td class="px-4 py-2 text-gray-600">${item.confidence}%</td>

            <td class="px-4 py-2 text-right">
              <a href="#" class="text-blue-600 font-medium hover:underline">${item.odds}</a>
            </td>

            ${idx == 0 ? `<td rowspan="${group.length}" class="px-0 py-2 align-middle text-center">
              <button class="p-1 text-gray-600 hover:text-blue-600" title="Open all odds">
                <ion-icon class="text-2xl" name="chevron-forward"></ion-icon>
              </button>
            </td>` : ''}
          </tr>
        `);
      });

      // "View more middles" row
      tbody.append(`
        <tr class="bg-gray-50">
          <td colspan="8" class="px-4 py-2 text-blue-600 text-sm hover:underline cursor-pointer">
            <div class="w-full flex justify-end pr-6">+ 0 more middles for this event</div>
          </td>
        </tr>F
      `);

      tbodyContainer.append(tbody);
    })

    // attach event for calculator popout
    $(".calc-btn").on("click", function () {
      const page = $(this).data("page");
      const arb_item = $(this).data("item");

      const contentDiv = document.getElementById('calculator-arb-item')
      contentDiv.setAttribute('data-page', page)
      contentDiv.setAttribute('data-item', arb_item)

      const url = `/middle/calculator?page=${encodeURIComponent(page)}&middle_item=${encodeURIComponent(arb_item)}`
      fetch(url).then(x => x.text())
        .then(function (html) {
          contentDiv.innerHTML = html
        });
    });
  }

  function removeElementsByClass(className) {
    let elements = document.getElementsByClassName(className);
    while (elements.length > 0) {
      elements[0].parentNode.removeChild(elements[0]);
    }
  }

  function updatePagination(page, totalPages) {
    $("#page-info").text(`Page ${page} of ${totalPages}`);
    $("#prev-page").prop("disabled", page <= 1);
    $("#next-page").prop("disabled", page >= totalPages);
    currentPage = page;
  }

  $("#prev-page").on("click", function () {
    if (currentPage > 1) fetchMiddles(currentPage - 1);
  });

  $("#next-page").on("click", function () {
    fetchMiddles(currentPage + 1);
  });

  // initial load
  fetchMiddles(currentPage);
</script>
{% endblock content %}