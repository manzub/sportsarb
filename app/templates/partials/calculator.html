<input type="checkbox" id="calculator_modal" class="modal-toggle" />
<div class="modal" role="dialog">
  <div class="modal-box">
    <h3 class="text-lg font-bold">Stake/Profit Calculator</h3>
    <div id="calc-info" class="text-sm text-gray-600 mb-4 text-center"></div>

    <form id="calc-form" class="space-y-3">
      <fieldset class="fieldset">
        <legend class="fieldset-legend">Stake ($)</legend>
        <input type="number" id="stake" class="input w-full" value="100" step="0.01" placeholder="Enter amount" />
        <p class="label">Enter how much you want to stake</p>
      </fieldset>

      <div data-item="" data-page="" id="calculator-arb-item"></div>

      <div class="pt-3">
        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition">
          Calculate Profit
        </button>
      </div>
    </form>

    <div id="result" class="mt-4 text-center text-gray-800 font-semibold"></div>

    <div class="modal-action">
      <label for="calculator_modal" class="calc-close-btn btn">Close!</label>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {
    $("#calc-form").on("submit", function (e) {
      e.preventDefault();

      const stake = parseFloat($("#stake").val());
      if (isNaN(stake) || stake <= 0) {
        $("#result").text("Enter a valid stake amount.");
        return;
      }

      const opp = document.getElementById('opportunity');
      const calcType = opp.getAttribute('data-type') || 'surebet';

      if (calcType === 'surebet') {
        const profitMargin = parseFloat(opp.getAttribute('data-profit-margin')) / 100;
        const totalImpliedProb = parseFloat(opp.getAttribute('data-total-implied-prob'));

        // Extract odds from DOM
        const odds = Array.from(opp.querySelectorAll('.bet-amount')).map(bet =>
          1 / parseFloat(bet.getAttribute('data-implied-prob'))
        );

        if (odds.length < 2) {
          $("#result").text("Not enough outcomes to calculate.");
          return;
        }

        const [oddA, oddB] = odds;

        // Calculate proportional stakes for equal payout
        const stakeA = stake / (1 + (oddA / oddB));
        const stakeB = stake - stakeA;

        const payoutA = stakeA * oddA;
        const payoutB = stakeB * oddB;

        const profit = Math.min(payoutA, payoutB) - stake;
        const payout = Math.min(payoutA, payoutB);

        // Update result display
        $("#result").html(`
          <div>üí∞ Profit: <span class="price text-green-600" data-usd="${profit.toFixed(2)}">$${profit.toFixed(2)}</span></div>
          <div class="text-sm text-gray-600">Payout: <span class="price" data-usd="${payout.toFixed(2)}">$${payout.toFixed(2)}</span></div>
        `);

        // Update bet allocations in DOM
        const bets = opp.querySelectorAll('.bet-amount');
        bets[0].textContent = stakeA.toFixed(2);
        bets[1].textContent = stakeB.toFixed(2);
      } else if (calcType === 'middle') {
        const odd1 = parseFloat($("#odd1").val());
        const odd2 = parseFloat($("#odd2").val());
        const totalStake = stake
        if (isNaN(odd1) || isNaN(odd2) || odd1 <= 1 || odd2 <= 1) {
          $("#result").text("Please enter valid odds for both bookmakers.");
          return;
        }

        const stake1 = (totalStake * odd2) / (odd1 + odd2);
        const stake2 = totalStake - stake1;

        // Profit scenarios
        const profitMiddle = (stake1 * (odd1 - 1)) + (stake2 * (odd2 - 1)); // both win
        const oneWins = (stake1 * (odd1 - 1)) - stake2;                     // one wins, one loses
        const bothLose = -totalStake;                                       // both lose

        const payoutMiddle = totalStake + profitMiddle;
        const payoutOneWins = totalStake + oneWins;
        const payoutBothLose = totalStake + bothLose;

        $("#result").html(`
          <div>üéØ <strong>Hit Middle:</strong> 
            <span class="price text-green-600" data-usd="${profitMiddle.toFixed(2)}">$${profitMiddle.toFixed(2)}</span> 
            <small class="text-gray-500">(Payout: $${payoutMiddle.toFixed(2)})</small>
          </div>

          <div>‚öñÔ∏è <strong>One Wins:</strong> 
            <span class="price text-yellow-600" data-usd="${oneWins.toFixed(2)}">$${oneWins.toFixed(2)}</span> 
            <small class="text-gray-500">(Payout: $${payoutOneWins.toFixed(2)})</small>
          </div>

          <div>üíÄ <strong>Both Lose:</strong> 
            <span class="price text-red-600" data-usd="${bothLose.toFixed(2)}">$${bothLose.toFixed(2)}</span> 
            <small class="text-gray-500">(Payout: $${payoutBothLose.toFixed(2)})</small>
          </div>

          <div class="text-xs text-gray-500 mt-2">
            Balanced stakes ‚Äî Bet 1: <span class="price" data-usd="${stake1.toFixed(2)}">$${stake1.toFixed(2)}</span>,
            Bet 2: <span class="price" data-usd="${stake2.toFixed(2)}">$${stake2.toFixed(2)}</span>
          </div>
        `);
      }

      // ‚úÖ Convert to selected currency immediately
      if (typeof window.updatePrices === "function") {
        window.updatePrices();
      }
    });

    $(".calc-close-btn").on("click", function () {
      $("#result").html("");
    });
  });
</script>