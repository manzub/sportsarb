<input type="checkbox" id="calculator_modal" class="modal-toggle" />
<div class="modal" role="dialog">
  <div class="modal-box">
    <h3 class="text-lg font-bold">Stake/Profit Calculator</h3>
    <div id="calc-info" class="text-sm text-gray-600 mb-4 text-center"></div>

    <form id="calc-form" class="space-y-3">
      <fieldset class="fieldset">
        <legend class="fieldset-legend">Stake ($)</legend>
        <input type="number" id="stake" class="input w-full" value="100" step="0.01" placeholder="Enter amount" />
        <p class="label">Enter how much you want to stake</p>
      </fieldset>

      <div data-item="" data-page="" id="calculator-arb-item"></div>

      <div class="pt-3">
        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition">
          Calculate Profit
        </button>
      </div>
    </form>

    <div id="result" class="mt-4 text-center text-gray-800 font-semibold"></div>

    <div class="modal-action">
      <label for="calculator_modal" class="calc-close-btn btn">Close!</label>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {
    $("#calc-form").on("submit", function (e) {
      e.preventDefault();

      const stake = parseFloat($("#stake").val());
      if (isNaN(stake) || stake <= 0) {
        $("#result").text("Enter a valid stake amount.");
        return;
      }

      const opp = document.getElementById('opportunity');
      const calcType = opp.getAttribute('data-type') || 'surebet';

      if (calcType === 'surebet') {
        const profitMargin = parseFloat(opp.getAttribute('data-profit-margin')) / 100;
        const totalImpliedProb = parseFloat(opp.getAttribute('data-total-implied-prob'));

        const odds = Array.from(opp.querySelectorAll('.bet-amount')).map(bet =>
          1 / parseFloat(bet.getAttribute('data-implied-prob'))
        );

        if (odds.length < 2) {
          $("#result").text("Not enough outcomes to calculate.");
          return;
        }

        const stake = parseFloat($("#stake").val());
        const bets = opp.querySelectorAll('.bet-amount');

        let stakes = [];
        let payouts = [];
        let profit = 0;
        let payout = 0;

        // ---------- 2-WAY MARKET ----------
        if (odds.length === 2) {
          const [oddA, oddB] = odds;
          const stakeA = stake / (1 + (oddA / oddB));
          const stakeB = stake - stakeA;

          const payoutA = stakeA * oddA;
          const payoutB = stakeB * oddB;

          stakes = [stakeA, stakeB];
          payouts = [payoutA, payoutB];
          profit = Math.min(...payouts) - stake;
          payout = Math.min(...payouts);

          // ---------- 3-WAY MARKET ----------
        } else if (odds.length === 3) {
          const [oddA, oddB, oddC] = odds;
          const invSum = (1 / oddA) + (1 / oddB) + (1 / oddC);

          const stakeA = ((1 / oddA) / invSum) * stake;
          const stakeB = ((1 / oddB) / invSum) * stake;
          const stakeC = ((1 / oddC) / invSum) * stake;

          const payoutA = stakeA * oddA;
          const payoutB = stakeB * oddB;
          const payoutC = stakeC * oddC;

          stakes = [stakeA, stakeB, stakeC];
          payouts = [payoutA, payoutB, payoutC];
          profit = Math.min(...payouts) - stake;
          payout = Math.min(...payouts);
        }

        // Update results visually
        $("#result").html(`
          <div>üí∞ Profit: <span class="price text-green-600" data-usd="${profit.toFixed(2)}">$${profit.toFixed(2)}</span></div>
          <div class="text-sm text-gray-600">Payout: <span class="price" data-usd="${payout.toFixed(2)}">$${payout.toFixed(2)}</span></div>
        `);

        // Update each outcome's stake on the DOM
        bets.forEach((bet, i) => {
          if (stakes[i] !== undefined) bet.textContent = stakes[i].toFixed(2);
        });
      } else if (calcType === 'middle') {
        const odd1 = parseFloat($("#odd1").val());
        const odd2 = parseFloat($("#odd2").val());
        const totalStake = stake
        if (isNaN(odd1) || isNaN(odd2) || odd1 <= 1 || odd2 <= 1) {
          $("#result").text("Please enter valid odds for both bookmakers.");
          return;
        }

        const stake1 = (totalStake * odd2) / (odd1 + odd2);
        const stake2 = totalStake - stake1;

        // Profit scenarios
        const profitMiddle = (stake1 * (odd1 - 1)) + (stake2 * (odd2 - 1)); // both win
        const oneWins = (stake1 * (odd1 - 1)) - stake2;                     // one wins, one loses
        const bothLose = -totalStake;                                       // both lose

        const payoutMiddle = totalStake + profitMiddle;
        const payoutOneWins = totalStake + oneWins;
        const payoutBothLose = totalStake + bothLose;

        $("#result").html(`
          <div>üéØ <strong>Hit Middle:</strong> 
            <span class="price text-green-600" data-usd="${profitMiddle.toFixed(2)}">$${profitMiddle.toFixed(2)}</span> 
            <small class="text-gray-500">(Payout: $${payoutMiddle.toFixed(2)})</small>
          </div>

          <div>‚öñÔ∏è <strong>One Wins:</strong> 
            <span class="price text-yellow-600" data-usd="${oneWins.toFixed(2)}">$${oneWins.toFixed(2)}</span> 
            <small class="text-gray-500">(Payout: $${payoutOneWins.toFixed(2)})</small>
          </div>

          <div>üíÄ <strong>Both Lose:</strong> 
            <span class="price text-red-600" data-usd="${bothLose.toFixed(2)}">$${bothLose.toFixed(2)}</span> 
            <small class="text-gray-500">(Payout: $${payoutBothLose.toFixed(2)})</small>
          </div>

          <div class="text-xs text-gray-500 mt-2">
            Balanced stakes ‚Äî Bet 1: <span class="price" data-usd="${stake1.toFixed(2)}">$${stake1.toFixed(2)}</span>,
            Bet 2: <span class="price" data-usd="${stake2.toFixed(2)}">$${stake2.toFixed(2)}</span>
          </div>
        `);
      } else if (calcType === 'valuebet') {

        // Extract the backend attributes
        const odds = parseFloat(opp.getAttribute('data-odds'));
        const evPercent = parseFloat(opp.getAttribute('data-ev'));   // EV already a computed %
        const confidence = parseFloat(opp.getAttribute('data-confidence')); // confidence 0‚Äì1

        if (isNaN(odds) || odds <= 1) {
          $("#result").text("Invalid odds data for valuebet.");
          return;
        }

        // Stake field already taken above
        if (isNaN(stake) || stake <= 0) {
          $("#result").text("Enter a valid stake amount.");
          return;
        }

        // Expected profit = stake * EV%
        const expectedProfit = stake * (evPercent / 100);
        const expectedReturn = stake + expectedProfit;

        $("#result").html(`
          <div><strong>EV:</strong> ${evPercent.toFixed(2)}%</div>
          <div><strong>Confidence:</strong> ${(confidence * 100).toFixed(0)}%</div>
          <hr/>
          <div>Stake: ¬£${stake.toFixed(2)}</div>
          <div>Expected Profit: <span class="text-green-600">¬£${expectedProfit.toFixed(2)}</span></div>
          <div>Total Expected Return: ¬£${expectedReturn.toFixed(2)}</div>
        `);
      }

      // ‚úÖ Convert to selected currency immediately
      if (typeof window.updatePrices === "function") {
        window.updatePrices();
      }
    });

    $(".calc-close-btn").on("click", function () {
      $("#result").html("");
    });
  });
</script>