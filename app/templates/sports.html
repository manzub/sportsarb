{% extends 'base.html' %}

{% block content %}
<section class="w-full max-w-7xl mx-auto px-4 py-10">

  <h1 class="text-4xl font-bold mb-8 text-bet365yellow text-center">
    Sports Data Overview
  </h1>

  {% if sports %}
  <div class="w-full overflow-x-auto border border-gray-700 rounded-lg">

    <table class="w-full text-left text-gray-300">
      <thead class="bg-gray-900 text-gray-200 uppercase text-sm border-b border-gray-700">
        <tr>
          <th class="py-3 px-4">Sport</th>
          <th class="py-3 px-4">League</th>
          <th class="py-3 px-4 text-center">Favorite</th>
        </tr>
      </thead>

      <tbody class="divide-y divide-gray-800">
        {% for item in sports %}
        <tr class="hover:bg-bet365green transition cursor-pointer select-none">
          <td class="py-3 px-4 font-medium">{{ item.sport }}</td>
          <td class="py-3 px-4">{{ item.league }}</td>
          <td class="py-3 px-4 text-center">
            <input type="checkbox" {{disabled if current_user.is_authenticated else ''}} class="toggle toggle-success favorite-checkbox" data-sport="{{ item.sport }}"
              data-league="{{ item.league }}" {% if item.is_favorite %}checked{% endif %}>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

  </div>

  {% else %}
  <p class="text-gray-400 text-center mt-8">No sports data available yet.</p>
  {% endif %}
</section>

<script>
  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

  document.querySelectorAll('.favorite-checkbox').forEach(chk => {
    chk.addEventListener('change', async (e) => {
      const league = e.target.dataset.league;
      const isFavorite = e.target.checked;

      try {
        const res = await fetch('/api/sports/toggle-favorite', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          },
          body: JSON.stringify({ league, favorite: isFavorite })
        });

        const data = await res.json();
        if (!data.success) {
          e.target.checked = !isFavorite;
          alert('Failed to update favorite status.');
        }
      } catch (err) {
        console.error(err);
        e.target.checked = !isFavorite;
      }
    });
  });
</script>
{% endblock content %}