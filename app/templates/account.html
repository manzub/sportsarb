{% extends 'base.html' %}

{% block content %}
<section class="w-full min-h-screen bg-gray-950 text-gray-200 flex flex-col lg:flex-row">

  <!-- MAIN CONTENT -->
  <div class="w-full lg:w-3/4 p-8">

    <h1 class="text-3xl font-bold text-bet365yellow mb-10">My Account / {{current_user.email}}</h1>

    {% if pending_plan_id %}
    <div class="px-4 py-3 mb-4 leading-normal text-green-700 bg-green-100 rounded-lg" role="alert">
      <p class="font-bold">You have a pending plan!</p>
      <p>Click the below link to complete your subscription and unlock unlimited earnings!</p>
      <a class="font-bold" href="/plans/checkout/{{pending_plan_id}}">Click Here</a>
    </div>
    {% endif %}
    <!-- SUBSCRIPTION CARD -->
    <div class="bg-gray-900 border border-gray-800 rounded-xl p-6 mb-10 shadow-lg">

      {% if subscription %}
      <p class="text-sm text-gray-400 uppercase tracking-wide mb-1">Current Plan</p>
      <h2 class="text-xl font-semibold text-gray-100">{{ plan.plan_name }}</h2>

      <div class="mt-6 space-y-2 text-gray-300">
        <p>
          <strong>Status:</strong>
          <span class="px-2 py-1 rounded text-gray-900
            {% if subscription.active %}
               bg-bet365green
            {% else %}
               bg-gray-600
            {% endif %}
          ">
            {{ 'Active' if subscription.active else 'Inactive' }}
          </span>
        </p>

        <p><strong>Start Date:</strong> {{ subscription.start_date.strftime('%b %d, %Y') if subscription.start_date else
          'â€”' }}</p>

        <p><strong>End Date:</strong> {{ subscription.end_date.strftime('%b %d, %Y') if subscription.end_date else 'â€”'
          }}</p>
      </div>

      <div class="mt-6">
        <a href="/#pricing"
          class="inline-block bg-bet365green hover:bg-bet365green/80 text-gray-900 text-sm font-semibold py-2 px-4 rounded-lg transition">
          Change Plan
        </a>
      </div>

      {% else %}
      <p class="text-gray-400 mb-4">You donâ€™t have an active plan yet.</p>
      <a href="/#pricing"
        class="inline-block bg-bet365green hover:bg-bet365green/80 text-gray-900 font-semibold py-2 px-4 rounded-lg">
        View Plans
      </a>
      {% endif %}
    </div>

    <!-- NOTIFICATION SETTINGS -->
    <div class="bg-gray-900 border border-gray-800 rounded-xl p-6 shadow-lg">

      <h2 class="text-2xl font-semibold text-gray-100 mb-6">Notification Settings</h2>

      <!-- EMAIL -->
      <div class="mb-8">
        <div class="flex items-center justify-between">
          <label for="emailNotify" class="font-medium text-gray-200">Email Notifications</label>
          <input type="checkbox" id="emailNotify" {% if alerts.email_notify %}checked{% endif %}
            class="h-5 w-5 cursor-pointer accent-bet365green">
        </div>
        <p class="text-sm text-gray-400 mt-1">
          Receive email alerts when new arbitrage opportunities appear.
        </p>
      </div>

      <!-- PUSH -->
      <div>
        <div class="flex items-center justify-between">
          <label for="pushNotify" class="font-medium text-gray-200">Browser Push Notifications</label>
          <input type="checkbox" id="pushNotify" {% if alerts.webpush_info %}checked{% endif %}
            class="h-5 w-5 cursor-pointer accent-bet365green">
        </div>
        <p id="pushStatus" class="text-sm text-gray-400 mt-1">
          {% if alerts.webpush_info %}
          âœ… Push notifications enabled
          {% else %}
          Push notifications are off
          {% endif %}
        </p>
      </div>

    </div>

  </div>

  {% block sidebar %}
  {% include 'partials/account_sidebar.html' %}
  {% endblock sidebar %}

</section>

<script>
  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

  // EMAIL NOTIFY
  document.getElementById("emailNotify").addEventListener("change", async (e) => {
    const enabled = e.target.checked;
    await fetch("/account/notifications/email", {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken },
      body: JSON.stringify({ enabled })
    });
  });

  // PUSH
  const vapidPublicKey = "{{ VAPID_PUBLIC_KEY }}";

  document.getElementById("pushNotify").addEventListener("change", async (e) => {
    const pushStatus = document.getElementById("pushStatus");
    const pushEnabled = e.target.checked;

    if (!('serviceWorker' in navigator)) {
      alert("Browser doesn't support push notifications.");
      e.target.checked = false;
      return;
    }

    const registration = await navigator.serviceWorker.register("/service-worker.js");
    await navigator.serviceWorker.ready;
    const subscription = await registration.pushManager.getSubscription();

    if (pushEnabled) {
      try {
        const newSub = await registration.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(vapidPublicKey),
        });

        const res = await fetch("/api/webpush/subscribe", {
          method: "POST",
          headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken },
          body: JSON.stringify(newSub),
        });

        if (res.ok) {
          pushStatus.innerText = "âœ… Push notifications enabled";
        } else {
          pushStatus.innerText = "âŒ Failed to enable push";
          e.target.checked = false;
        }

      } catch (err) {
        pushStatus.innerText = "âŒ Subscription failed";
        e.target.checked = false;
      }

    } else {
      try {
        if (subscription) await subscription.unsubscribe();

        const res = await fetch("/api/webpush/unsubscribe", {
          method: "POST",
          headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken },
        });

        pushStatus.innerText = res.ok
          ? "ðŸš« Push notifications disabled"
          : "âš ï¸ Failed to disable push";

      } catch (err) {
        pushStatus.innerText = "âš ï¸ Error disabling push";
      }
    }
  });

  function urlBase64ToUint8Array(base64String) {
    const padding = "=".repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
    return Uint8Array.from(window.atob(base64), c => c.charCodeAt(0));
  }
</script>
{% endblock content %}