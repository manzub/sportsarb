{% extends 'base.html' %}

{% block content %}
<div class="py-12 px-4">
  <div class="max-w-lg w-full p-4">
    <h1 class="text-2xl font-bold text-gray-800 mb-6">My Account</h1>

    {% if subscription %}
    <div class="bg-gray-50 mb-6">
      <p class="text-sm text-gray-500 uppercase tracking-wide mb-1">Current Plan</p>
      <h2 class="text-lg font-semibold text-gray-800">{{ plan.plan_name }}</h2>

      <div class="mt-4 text-sm text-gray-600">
        <p><strong>Status:</strong>
          <span class="px-2 py-1 rounded text-white 
              {% if subscription.active %}bg-green-600{% else %}bg-gray-500{% endif %}">
            {{ 'Active' if subscription.active else 'Inactive' }}
          </span>
        </p>
        <p class="mt-2"><strong>Start Date:</strong> {{ subscription.start_date.strftime('%b %d, %Y') if
          subscription.start_date else '—' }}</p>
        <p><strong>End Date:</strong> {{ subscription.end_date.strftime('%b %d, %Y') if subscription.end_date else '—'
          }}</p>
      </div>
    </div>

    <div class="flex justify-between items-center">
      <a href="{{ url_for('plans.overview') }}"
        class="inline-block bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold py-2 px-4 rounded-md transition">
        Change Plan
      </a>
    </div>

    {% else %}
    <div class="">
      <p class="text-gray-600 mb-6">You don’t have an active plan yet.</p>
      <a href="{{ url_for('plans.overview') }}"
        class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md">
        View Plans
      </a>
    </div>
    {% endif %}

    <hr class="my-8 border-gray-300">

    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Notification Settings</h2>

      <!-- EMAIL NOTIFICATION -->
      <div class="mb-6">
        <div class="flex items-center justify-between">
          <label for="emailNotify" class="text-gray-700 font-medium">Email Notifications</label>
          <input type="checkbox" id="emailNotify" {% if alerts.email_notify %}checked{% endif %}
            class="h-5 w-5 text-blue-600 border-gray-300 rounded cursor-pointer">
        </div>
        <p class="text-sm text-gray-500 mt-1">
          Receive email alerts when new arbitrage opportunities are detected.
        </p>
      </div>

      <!-- PUSH NOTIFICATION -->
      <div>
        <div class="flex items-center justify-between">
          <label for="pushNotify" class="text-gray-700 font-medium">Browser Push Notifications</label>
          <input type="checkbox" id="pushNotify" {% if alerts.webpush_info %}checked{% endif %}
            class="h-5 w-5 text-blue-600 border-gray-300 rounded cursor-pointer">
          </button>
        </div>
        <p id="pushStatus" class="text-sm text-gray-500 mt-1">
          {% if alerts.webpush_info %}
          ✅ Push notifications enabled
          {% else %}
          Push notifications are off
          {% endif %}
        </p>
      </div>
    </div>
  </div>
</div>

<script>
  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
  // --- EMAIL NOTIFICATION TOGGLE ---
  document.getElementById("emailNotify").addEventListener("change", async (e) => {

    const enabled = e.target.checked;
    await fetch("/account/notifications/email", {
      method: "POST",
      headers: { "Content-Type": "application/json", 'X-CSRFToken': csrfToken },
      body: JSON.stringify({ enabled })
    });
  });

  // --- PUSH NOTIFICATIONS SETUP ---
  const vapidPublicKey = "{{ VAPID_PUBLIC_KEY }}";

  document.getElementById("pushNotify").addEventListener("change", async (e) => {
    const pushEnabled = e.target.checked;

    if (!('serviceWorker' in navigator)) {
      alert("Your browser doesn’t support push notifications.");
      e.target.checked = false;
      return;
    }

    const registration = await navigator.serviceWorker.register("/service-worker.js");
    await navigator.serviceWorker.ready;
    const subscription = await registration.pushManager.getSubscription();

    if (pushEnabled) {
      // SUBSCRIBE
      try {
        const newSub = await registration.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(vapidPublicKey),
        });

        const res = await fetch("/api/webpush/subscribe", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrfToken,
          },
          body: JSON.stringify(newSub),
        });

        if (res.ok) {
          pushStatus.innerText = "✅ Push notifications enabled";
        } else {
          pushStatus.innerText = "❌ Failed to enable push";
          e.target.checked = false;
        }
      } catch (err) {
        console.error("Error subscribing:", err);
        pushStatus.innerText = "❌ Subscription failed";
        e.target.checked = false;
      }
    } else {
      // UNSUBSCRIBE
      try {
        if (subscription) {
          await subscription.unsubscribe();
        }

        const res = await fetch("/api/webpush/unsubscribe", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrfToken,
          },
        });

        if (res.ok) {
          pushStatus.innerText = "🚫 Push notifications disabled";
        } else {
          pushStatus.innerText = "⚠️ Failed to disable push";
        }
      } catch (err) {
        console.error("Error unsubscribing:", err);
        pushStatus.innerText = "⚠️ Error disabling push";
      }
    }
  });

  function urlBase64ToUint8Array(base64String) {
    const padding = "=".repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
    const rawData = window.atob(base64);
    return Uint8Array.from([...rawData].map((c) => c.charCodeAt(0)));
  }
</script>
{% endblock content %}

{% block sidebar %}
{% include 'partials/account_sidebar.html' %}
{% endblock sidebar %}