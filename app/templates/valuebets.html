{% extends 'base.html' %}

{% block content %}
<div id="page-meta" data-mode="valuebets"
  class="card bg-gray-900 text-gray-200 border border-gray-800 rounded-xl shadow-lg">

  {% if not current_user.is_authenticated %}
  <!-- Not Logged In -->
  <div class="w-full bg-gray-900 border border-gray-700 text-gray-200 p-6 rounded-xl shadow-lg max-w-2xl mx-auto mt-10">
    <h2 class="text-xl font-bold text-emerald-400 mb-2">Login Required</h2>
    <p class="text-gray-300 mb-4">
      You need to log in to view Valuebets. Create an account or sign in to continue.
    </p>

    <div class="flex gap-3 mt-4">
      <a href="{{ url_for('auth.login') }}"
        class="btn bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-5 py-2.5 rounded-lg">
        Login
      </a>

      <a href="/#pricing"
        class="btn bg-gray-800 hover:bg-gray-700 border border-gray-600 text-gray-200 font-semibold px-5 py-2.5 rounded-lg">
        View Plans
      </a>
    </div>
  </div>

  {% elif not has_access_values %}
  <!-- Logged In But No Access -->
  <div class="w-full bg-gray-900 border border-gray-700 text-gray-200 p-6 rounded-xl shadow-lg max-w-2xl mx-auto mt-10">
    <h2 class="text-xl font-bold text-emerald-400 mb-2">Upgrade Required</h2>
    <p class="text-gray-300 mb-4">
      Your current plan does not include Valuebets. Upgrade to unlock all valuebet opportunities and
      EV-positive values.
    </p>

    <a href="/#pricing" class="btn bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-5 py-2.5 rounded-lg">
      Upgrade Plan
    </a>
  </div>

  {% else %}
  <!-- HAS ACCESS – Show the full original content -->
  <div class="mb-4 p-4">
    <img src="/static/img/banner-1.jpg" class="w-full h-64 object-cover rounded-xl shadow-md border border-gray-700">
  </div>


  <div class="card-body p-0">

    <!-- HEADER -->
    <div class="mx-4 mt-4 flex items-center justify-between">
      <p class="text-2xl font-bold">Found {{ total_value_items }} valuebets</p>

      <div class="actions flex items-center gap-2">
        <button id="prev-page"
          class="px-3 py-2 rounded-lg bg-gray-800 border border-gray-700 text-gray-300 hover:bg-gray-700 disabled:opacity-50">
          ← Prev
        </button>

        <button id="next-page"
          class="px-3 py-2 rounded-lg bg-gray-800 border border-gray-700 text-gray-300 hover:bg-gray-700 disabled:opacity-50">
          Next →
        </button>
      </div>
    </div>

    <!-- WARNING -->
    <div class="p-4">
      <div class="alert bg-red-900 border border-red-700 text-red-200 p-3 rounded-lg">
        <p>
          Before you place any bets, check the events, odds, and bookmaker rules.
          <br><br>
          We work hard to keep everything accurate, but errors can happen.
        </p>
      </div>
    </div>

    <!-- TABLE -->
    <div class="m-3 overflow-x-auto">
      <table id="valuebets-body" class="w-full text-sm text-left border-collapse text-gray-300">

        <thead class="bg-gray-800 text-gray-100 border-b border-gray-700">
          <tr>
            <th class="px-3 py-3"></th>
            <th class="px-3 py-3 font-semibold">Bookmaker</th>
            <th class="px-3 py-3 font-semibold">Time</th>
            <th class="px-3 py-3 font-semibold">Event</th>
            <th class="px-3 py-3 font-semibold">Market</th>
            <th class="px-3 py-3 font-semibold">Odds</th>
            <th class="px-3 py-3 font-semibold">Confidence</th>
            <th class="px-3 py-3 font-semibold">Expected Value</th>
            <th class="px-3 py-3"></th>
          </tr>
        </thead>

        <!-- JS will populate body rows -->
      </table>
    </div>

  </div>
  {% endif %}
</div>

{% block sidebar %}
{% include 'partials/sidebar.html' %}
{% endblock sidebar %}

<script>
  let currentPage = 1;

  function renderValuebets(items, tbodyContainer) {

    // Group by valuebet_id
    const grouped = {};
    items.forEach(item => {
      if (!grouped[item.valuebet_id]) grouped[item.valuebet_id] = [];
      grouped[item.valuebet_id].push(item);
    });

    Object.keys(grouped).forEach(id => {
      const group = grouped[id];
      const tbody = $("<tbody>")
        .addClass("valuebets_record border-t border-gray-700")
        .attr("data-id", id);

      group.forEach((item, idx) => {
        tbody.append(`
        <tr class="hover:bg-gray-800 transition border-b border-gray-800">

          <!-- ACTIONS -->
          ${idx === 0
            ? `
              <td rowspan="${group.length}" class="px-3 py-2 align-top">
                <div class="flex flex-col items-start gap-2 mt-1">

                  <!-- Calculator -->
                  <label for="calculator_modal"
                        data-page="valuebets"
                        data-item="${item.valuebet_id}"
                        class="calc-btn p-2 rounded-lg bg-gray-800 border border-gray-700 text-emerald-400 hover:bg-gray-700 transition"
                        title="Valuebet calculator">
                    <ion-icon class="w-5 h-5" name="calculator"></ion-icon>
                  </label>

                  <!-- More options (disabled) -->
                  <button disabled 
                          class="p-2 rounded-lg bg-gray-800 border border-gray-700 text-gray-500 cursor-not-allowed"
                          title="More options">
                    <ion-icon class="w-5 h-5" name="ellipsis-vertical"></ion-icon>
                  </button>

                </div>
              </td>
              `
            : ""
          }

          <!-- BOOKMAKER -->
          <td class="px-3 py-2">
            <a href="${item.bookmaker_link}" target="_blank"
               class="text-emerald-400 hover:underline">
              ${item.bookmaker}
            </a>
            <div class="text-xs text-gray-500">${item.sport || "N/A"}</div>
          </td>

          <!-- DATE / TIME -->
          ${idx === 0
            ? `
              <td rowspan="${group.length}" class="px-3 py-2 align-top">
                <div class="text-gray-300">${item.date}</div>
                <div class="text-xs text-gray-500">${item.time}</div>
              </td>
              `
            : ""
          }

          <!-- EVENT -->
          <td class="px-3 py-2">
            <div class="text-emerald-300 font-semibold">${item.bet_recommendation}</div>
            <div class="text-xs text-gray-400">${item.event}</div>
            <div class="text-xs text-gray-500">${item.sport}</div>
          </td>

          <!-- MARKET -->
          <td class="px-3 py-2 text-gray-400">${item.market}</td>

          <!-- ODDS -->
          <td class="px-3 py-2 text-right">
            <span class="text-emerald-400 font-semibold">${item.odds}</span>
          </td>

          <!-- CONFIDENCE -->
          <td class="px-3 py-2 text-right text-gray-300">${item.confidence}%</td>

          <!-- EV -->
          <td class="px-3 py-2 text-right font-semibold 
              ${item.expected_value > 0 ? "text-emerald-400" : "text-red-400"}">
            ${item.expected_value}
          </td>
        </tr>
      `);
      });

      // append grouped block
      tbodyContainer.append(tbody);
    });

    // calculator action
    $(".calc-btn").on("click", function () {
      const page = $(this).data("page");
      const valueItem = $(this).data("item");

      const contentDiv = document.getElementById("calculator-arb-item");
      contentDiv.setAttribute("data-page", page);
      contentDiv.setAttribute("data-item", valueItem);

      const url = `/valuebet/calculator?page=${encodeURIComponent(
        page
      )}&value_item=${encodeURIComponent(valueItem)}`;

      fetch(url)
        .then((response) => {
          if (!response.ok) throw new Error("Item not found or expired");
          return response.text();
        })
        .then((html) => {
          contentDiv.innerHTML = html;
        })
        .catch((err) => {
          console.warn(err.message);
          alert("This valuebet is no longer available. Refreshing...");
          window.location.reload();
        });
    });
  }


  function removeElementsByClass(className) {
    let elements = document.getElementsByClassName(className);
    while (elements.length > 0) {
      elements[0].parentNode.removeChild(elements[0]);
    }
  }

  function updatePagination(page, totalPages) {
    $("#page-info").text(`Page ${page} of ${totalPages}`);
    $("#prev-page").prop("disabled", page <= 1);
    $("#next-page").prop("disabled", page >= totalPages);
    currentPage = page;
  }

  $("#prev-page").on("click", () => fetchData(currentPage - 1));
  $("#next-page").on("click", () => fetchData(currentPage + 1));

  // initial load
  fetchData(currentPage);
</script>
{% endblock content %}