{% extends 'base.html' %}

{% block content %}
<div class="card bg-base-100">
  <div class="card-body p-0">
    <!-- content here -->
    <div class="mx-4 mt-4 flex items-center justify-between">
      <div class="">
        <p class="text-2xl font-bold">Found {{total_value_items}} valuebets</p>
      </div>

      <div class="actions">
        <button id="prev-page" class="btn hover:bg-gray-300 px-2 py-1 rounded disabled:opacity-70">
          ← Prev
        </button>
        <button id="next-page" class="btn hover:bg-gray-300 px-4 py-2 rounded disabled:opacity-50">
          Next →
        </button>
      </div>
    </div>

    <!-- warning here -->
    <div class="p-4">
      <div role="alert" class="alert alert-error alert-soft">
        <p class="text-red-600">Before you place any bets, we strongly recommend that you check the events, odds, and
          bookmaker's rules. <br><br>We are constantly working to improve the quality of our service, but errors and
          discrepancies can occur, unfortunately.</p>
      </div>
    </div>

    <div class="m-3 overflow-x-auto">
      <table id="values-body" style="font-size: 12px;" class="w-full text-sm text-left text-gray-700 border-collapse">
        <thead class="bg-gray-100 text-gray-800">
          <tr>
            <th></th>
            <th class="px-4 py-3 font-semibold">Bookmaker</th>
            <th class="px-4 py-3 font-semibold">Time</th>
            <th class="px-4 py-3 font-semibold">Event</th>
            <th class="px-4 py-3 font-semibold">Market</th>
            <th class="px-4 py-3 font-semibold">Odds</th>
            <th class="px-4 py-3 font-semibold">Confidence</th>
            <th class="px-4 py-3 font-semibold">Expected Value</th>
            <th></th>
          </tr>
        </thead>

        <!-- body here -->
      </table>
    </div>
    <!-- datatable end -->
  </div>
</div>
<script>
  const API_URL = "/api/values";

  let currentPage = 1;
  const perPage = 20;
  let _market = '';
  let _time = ''

  function fetchValues(page = 1, market = '', commence_time = _time) {
    _market = market;
    _time = commence_time
    $.ajax({
      url: API_URL,
      data: { page: page, limit: perPage, market: _market, commence_time: _time },
      method: "GET",
      success: function (response) {
        if (response.data.length == 0) {
          $("#values-body").html(`
              <tr>
                <td colspan="7" class="text-center py-4 text-gray-500">
                  Failed to load data.
                </td>
              </tr>
            `);
        } else {
          renderValues(response.data);
          updatePagination(response.page, response.total_pages);
        }
      },
      error: function () {
        $("#values-body").html(`
              <tr>
                <td colspan="7" class="text-center py-4 text-gray-500">
                  Failed to load data.
                </td>
              </tr>
            `);
      },
    });
  }

  function renderValues(items) {
    const tbodyContainer = $("#values-body");
    //tbodyContainer.empty();
    removeElementsByClass('value_record')

    // Group by surebet_id
    const grouped = {};
    items.forEach((item) => {
      if (!grouped[item.middle_id]) grouped[item.middle_id] = [];
      grouped[item.middle_id].push(item);
    });

    Object.keys(grouped).forEach((id) => {
      const group = grouped[id];
      const tbody = $("<tbody>")
        .addClass("value_record border-t border-gray-200")
        .attr("data-id", id);

      group.forEach((item, idx) => {
        tbody.append(`
          <tr class="hover:bg-gray-50 transition">
            <!-- Actions -->
            <td class="px-4 py-2 align-top">
              <div class="flex flex-col items-start">
                <!-- Action buttons -->
                <div class="flex items-center gap-2 mt-2">
                  <label for="calculator_modal" data-page="surebets" data-item="${item.valuebet_id}" class="calc-btn p-1.5 text-gray-600 hover:text-blue-600" title="Surebet calculator">
                    <ion-icon class="w-5 h-5" name="calculator"></ion-icon>
                  </label>
                  <button disabled class="p-1.5 text-gray-600 hover:text-gray-900" title="More options">
                    <ion-icon class="w-5 h-5" name="ellipsis-vertical"></ion-icon>
                  </button>
                </div>
              </div>
            </td>

            <!-- Row: bookmaker -->
            <td class="px-4 py-2">
              <a href="${Object.values(item.bookmaker_link)[0]}" target="_blank" class="text-blue-600 hover:underline">${item.bookmaker}</a>
              <div class="text-xs text-gray-500">${item.sport || 'N/A'}</div>
            </td>

            <td class="px-4 py-2">
              <a href="#" class="text-blue-600 hover:underline">${item.date}</a>
              <div class="text-xs text-gray-500">${item.time}</div>
            </td>

            <td class="px-4 py-2">
              <a href="#" class="text-blue-600 hover:underline">${item.bet_recommendation}</a>
              <a href="#" class="text-xs text-gray-500">${item.event}</a>
              <div class="text-xs text-gray-500">${item.sport || ''}</div>
            </td>

            <td class="px-4 py-2 text-gray-600">${item.market}</td>

            <td class="px-4 py-2 text-right">
              <a href="#" class="text-blue-600 font-medium hover:underline">${item.odds}</a>
            </td>

            <td class="px-4 py-2 text-right">${item.confidence}</td>
            <td class="px-4 py-2 text-right">${item.expected_value}</td>
          </tr>
        `);
      });

      tbodyContainer.append(tbody);
    })

    // attach event for valuebet calculator popout
    $(".calc-btn").on("click", function () {
      const page = $(this).data("page");
      const value_item = $(this).data("item");

      const contentDiv = document.getElementById('calculator-arb-item');
      contentDiv.setAttribute('data-page', page);
      contentDiv.setAttribute('data-item', value_item);

      const url = `/valuebet/calculator?page=${encodeURIComponent(page)}&value_item=${encodeURIComponent(value_item)}`;

      fetch(url)
        .then(response => {
          if (!response.ok) throw new Error("Item not found or expired");
          return response.text();
        })
        .then(html => {
          contentDiv.innerHTML = html;
        })
        .catch(err => {
          console.warn(err.message);
          alert("This valuebet opportunity is no longer available. Refreshing list...");
          window.location.reload();
        });
    });
  }

  function removeElementsByClass(className) {
    let elements = document.getElementsByClassName(className);
    while (elements.length > 0) {
      elements[0].parentNode.removeChild(elements[0]);
    }
  }

  function updatePagination(page, totalPages) {
    $("#page-info").text(`Page ${page} of ${totalPages}`);
    $("#prev-page").prop("disabled", page <= 1);
    $("#next-page").prop("disabled", page >= totalPages);
    currentPage = page;
  }

  $("#prev-page").on("click", function () {
    if (currentPage > 1) fetchValues(currentPage - 1, _market);
  });

  $("#next-page").on("click", function () {
    fetchValues(currentPage + 1, _market);
  });

  // initial load
  fetchValues(currentPage);
</script>
{% endblock content %}