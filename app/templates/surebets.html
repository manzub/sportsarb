{% extends 'base.html' %}

{% block content %}
<section id="page-meta" data-mode="surebets" class="w-full max-w-7xl mx-auto py-12 px-4">
  <!-- FEATURES STRIP -->
  <section class="w-full bg-gray-900 py-10 border-b border-gray-800">
    <div class="max-w-7xl mx-auto grid grid-cols-2 md:grid-cols-4 text-center gap-6 text-gray-200">
      <div>
        <p class="text-3xl font-bold text-bet365green">24/7</p>
        <p class="text-sm text-gray-400">Live Monitoring</p>
      </div>
      <div>
        <p class="text-3xl font-bold text-yellow-400">50+</p>
        <p class="text-sm text-gray-400">Bookmakers</p>
      </div>
      <div>
        <p class="text-3xl font-bold text-blue-400">{{ total_surebet_items }}+</p>
        <p class="text-sm text-gray-400">Surebets Today</p>
      </div>
      <div>
        <p class="text-3xl font-bold text-purple-400">0% Guesswork</p>
        <p class="text-sm text-gray-400">Pure Math</p>
      </div>
    </div>
  </section>

  <!-- INFO BANNER -->
  <section class="max-w-5xl mx-auto my-10 px-6">
    <div class="bg-gray-900 border border-gray-800 px-6 py-6 rounded-xl shadow">
      <h2 class="text-xl font-semibold text-bet365yellow mb-3">
        Profit no matter the outcome.
      </h2>

      <p class="text-gray-300 mb-4">
        We detect price discrepancies between bookmakers before they adjust the markets.
        You exploit the gap.
      </p>

      <a href="/#pricing"
        class="inline-block bg-bet365green hover:bg-bet365green/80 text-gray-900 font-semibold py-3 px-5 rounded-lg shadow transition">
        View Plans →
      </a>
    </div>
  </section>

  <!-- DISCLAIMER -->
  <section class="max-w-5xl mx-auto px-6">
    <div role="alert" class="bg-red-900/40 border border-red-700 p-4 rounded-xl text-red-300 shadow">
      <p class="text-sm leading-relaxed">
        Always verify odds before placing your bets. Small data delays can cause mismatches.
      </p>
    </div>
  </section>

  <div class="mb-4 p-4">
    <img src="/static/img/banner-1.jpg" class="w-full h-32 object-cover rounded-xl shadow-md border border-gray-700">
  </div>

  <!-- TABLE SECTION -->
  <section class="max-w-7xl mx-auto px-4 mt-12">

    <div class="flex items-center justify-between mb-4 text-gray-200">
      <div>
        <p class="text-2xl font-bold">Found {{ total_surebet_items }} surebets</p>
        <p class="text-gray-400 text-sm">Showing examples under 1% profit</p>
      </div>

      <div class="flex gap-2">
        <button id="prev-page"
          class="px-3 py-2 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded text-gray-300 disabled:opacity-40">
          ← Prev
        </button>
        <button id="next-page"
          class="px-3 py-2 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded text-gray-300 disabled:opacity-40">
          Next →
        </button>
      </div>
    </div>

    <div class="overflow-x-auto rounded-lg border border-gray-800 shadow-lg">
      <table id="surebets-body" class="w-full text-sm text-gray-300">
        <!-- Injected body -->
      </table>
    </div>

  </section>
</section>

{% block sidebar %}
{% include 'partials/sidebar.html' %}
{% endblock sidebar %}

<script>
  let currentPage = 1;

  function renderSurebets(items, tbodyContainer) {

    const groupMap = {};
    items.forEach(item => {
      if (!groupMap[item.surebet_id]) groupMap[item.surebet_id] = [];
      groupMap[item.surebet_id].push(item);
    });

    Object.keys(groupMap).forEach(id => {
      const group = groupMap[id];

      const tbody = $("<tbody>")
        .addClass("surebets_record border-t border-gray-200")   // unified class
        .attr("data-id", id);

      group.forEach((item, idx) => {
        tbody.append(`
        <tr class="hover:bg-[#1b2a1f] transition border-b border-gray-800">

          ${idx === 0 ? `
          <td rowspan="${group.length}"
              class="px-4 py-3 align-top bg-[#111] border-r border-gray-800">
            <div class="flex flex-col items-start gap-1">
              <span class="font-semibold text-green-500 text-sm cursor-help">
                +${item.profit}%
              </span>
              <span class="text-[10px] text-gray-500">${item.age || "n/a"}</span>

              <div class="flex items-center gap-3 mt-1">
                <label for="calculator_modal"
                       data-page="surebets"
                       data-item="${item.surebet_id}"
                       class="calc-btn p-1.5 rounded-md text-gray-400 hover:text-green-400 transition"
                       title="Surebet Calculator">
                  <ion-icon class="w-5 h-5" name="calculator-outline"></ion-icon>
                </label>

                <button disabled class="p-1.5 text-gray-500 hover:text-gray-300 transition">
                  <ion-icon class="w-5 h-5" name="ellipsis-vertical"></ion-icon>
                </button>
              </div>
            </div>
          </td>
          ` : ""}

          <td class="px-4 py-3 bg-[#111] border-r border-gray-800">
            <a href="${item.bookmaker_link}" target="_blank"
               class="text-blue-400 hover:underline font-medium">
              ${item.bookmaker}
            </a>
            <div class="text-[11px] text-gray-500">${item.sport_name}</div>
          </td>

          ${idx === 0 ? `
          <td rowspan="${group.length}"
              class="px-4 py-3 bg-[#111] border-r border-gray-800 align-top">
            <div class="flex flex-col">
              <span class="text-blue-400 hover:underline cursor-pointer">${item.date}</span>
              <span class="text-[11px] text-gray-500">${item.time}</span>
            </div>
          </td>
          ` : ""}

          <td class="px-4 py-3 bg-[#111] border-r border-gray-800">
            <span class="text-blue-400 font-medium hover:underline cursor-pointer">
              ${item.event}
            </span>
            <div class="text-[11px] text-gray-500">${item.event_name}</div>
            <div class="text-[11px] text-gray-500">${item.tournament}</div>
          </td>

          <td class="px-4 py-3 bg-[#111] border-r border-gray-800 text-gray-400 uppercase text-xs">
            ${item.market_type}
          </td>

          <td class="px-4 py-3 bg-[#111] border-r border-gray-800 text-right">
            <span class="text-blue-300 font-semibold hover:underline cursor-pointer">
              ${item.odds}
            </span>
          </td>

          ${idx === 0 ? `
          <td rowspan="${group.length}"
              class="px-2 py-3 bg-[#111] text-center align-middle border-r border-gray-800">
            <button class="p-1 text-gray-400 hover:text-blue-400 transition" title="Open all odds">
              <ion-icon class="text-xl" name="chevron-forward-outline"></ion-icon>
            </button>
          </td>
          ` : ""}

        </tr>
      `);
      });

      tbody.append(`
      <tr class="bg-[#141414] border-b border-gray-800">
        <td colspan="7"
            class="px-4 py-2 text-blue-400 text-sm hover:text-blue-300 hover:underline cursor-pointer">
          <div class="w-full flex justify-end pr-6">+ 0 more best odds</div>
        </td>
      </tr>
    `);

      tbodyContainer.append(tbody);
    });

    // Calculator modal hookup
    $(".calc-btn").off("click").on("click", function () {
      const page = this.dataset.page;
      const arb_item = this.dataset.item;

      const contentDiv = document.getElementById('calculator-arb-item');
      contentDiv.setAttribute('data-page', page);
      contentDiv.setAttribute('data-item', arb_item);

      const url = `/surebet/calculator?page=${page}&arb_item=${arb_item}`;

      fetch(url)
        .then(res => res.ok ? res.text() : Promise.reject("Expired"))
        .then(html => { contentDiv.innerHTML = html; })
        .catch(() => {
          alert("This opportunity expired. Refreshing...");
          window.location.reload();
        });
    });
  }


  function removeElementsByClass(className) {
    let elements = document.getElementsByClassName(className);
    while (elements.length > 0) {
      elements[0].parentNode.removeChild(elements[0]);
    }
  }

  function updatePagination(page, totalPages) {
    $("#page-info").text(`Page ${page} of ${totalPages}`);
    $("#prev-page").prop("disabled", page <= 1);
    $("#next-page").prop("disabled", page >= totalPages);
    currentPage = page;
  }

  $("#prev-page").on("click", () => fetchData(currentPage - 1));
  $("#next-page").on("click", () => fetchData(currentPage + 1));

  // initial load
  fetchData(currentPage);
</script>
{% endblock %}